<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Promotional Offering</title>
    <!-- Let's use Bootstrap improve the default look a bit -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css"
    />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://unpkg.com/realm-web@1.2.0/dist/bundle.iife.js"></script>
    <script>
    /* NOTE: handle your API key with another method than what is provided in this example 
       * (dont paste your API key in your code its easily obtained by the browser view source)
       * API key is pasted here for a simple prototype example with out key management 
       */       
      const credentials = Realm.Credentials.apiKey("Pa6MvexZvQ0mfv98p0fOHzavEdjHkiruvH9EPafFggVpTZ5hNoSpqLXX8C57i5gK");
      const app = Realm.App.getApp('sales-jpqdz');

      async function displayCustomersOnLoad() {
        try {
            const user = await app.logIn(credentials)
            const client = app.currentUser.mongoClient("mongodb-atlas")
            const db = client.db('sample_supplies');
            displayCustomers()
        } catch (err) {
            console.error("Failed to log in", err);
        }
      }
      
      async function displayCustomers() {
        const vEmail = document.getElementById("customer_email").value;
        const vStoreLocation = document.getElementById("store_location").value;
        const vAge = document.getElementById("customer_age").value;
        var searchDoc = {};
        //Create the search doc off of the specified criteria
        if (vStoreLocation != "") {
          searchDoc = {"storeLocation": vStoreLocation};
        }
        if (vAge != "") {
          searchDoc = {"customer.age": {$gte: parseInt(vAge)}};
        }
        if (vAge != "" && vStoreLocation != "") {
          searchDoc = {"customer.age": {$gte: parseInt(vAge)},"storeLocation": vStoreLocation};
        }
        if (vEmail != "") {
          searchDoc = {"customer.email": vEmail};
        }
        const tStrt = "<div><table class=\"table table-hover\"><tr><th>Store Location</th><th>Purchase Method</th><th>Age</th>" +
          "<th>Gender</th><th>Email</th><th>Sale Date</th><th>Edit</th></tr>";
        try {
            const client = app.currentUser.mongoClient("mongodb-atlas")
            const db = client.db('sample_supplies');
            docs = await db.collection("sales").find(searchDoc, {limit: 25});

            const html = docs.map(c => "<tr>" +
                "<td>" + c.storeLocation +  "</td>" +
                "<td>" + c.purchaseMethod +  "</td>" + 
                "<td>" + c.customer.age + "</td>" +
                "<td>" + c.customer.gender + "</td>" +  
                "<td>" + c.customer.email + "</td>" + 
                "<td>" + c.saleDate + "</td>" + 
                "<td> " + 
                "<button type=\"checkbox\" class=\"blueTable\"" + 
                "onClick=\"editCustomer(\'" + c.customer.email +"\')\">" + 
                "<i class=\"material-icons\" style=\"font-size:18px\">" + 
                "mode_edit</i></button>" + 
                "</td>" + 
                "</tr>").join("");
            document.getElementById("customers").innerHTML = tStrt + html + "</table></div>";
        } catch(err) {
            console.error("Failed to run query", err);
        }
    }
      
    async function editCustomer(aEmail) {
        //build the html for dynamically displaying additional fields to edit
        editSearchDoc = {"customer.email": aEmail};

        try {
            const client = app.currentUser.mongoClient("mongodb-atlas")
            const db = client.db('sample_supplies');
            sale_doc = await db.collection("sales").findOne(editSearchDoc, {limit: 25});

            var vGender  = sale_doc.customer.gender;
            var vAge  = sale_doc.customer.age;
            var vEmail  = sale_doc.customer.email;
            var vSatisfaction  = sale_doc.customer.satisfaction;
            var vStoreLocation = sale_doc.storeLocation;
            var vPurchaseMethod = sale_doc.purchaseMethod;
            var vPromoCode = sale_doc.promoCode;
            if (typeof(vPromoCode) === 'undefined') {
                vPromoCode = ""
            }

            html = "<h3>Customer Details</h3>" + 
            "<table style=\"padding: 30px\">" +
            "<tr><td>Store Location:  </td><td>" + vStoreLocation + "</td></tr>" +
            "<tr><td>Age:  </td><td>" + vAge + "</td></tr>" +
            "<tr><td>Gender:  </td><td>" + vGender + "</td></tr>" +
            "<tr><td>Email:  </td><td>" + vEmail + "</td></tr>" +
            "<tr><td>Satisfaction:  </td><td>" + vSatisfaction + "</td></tr>" +
            "<tr><td>Purchase Method:  </td><td>" + vPurchaseMethod + "</td></tr>" +
            "<tr><td>Promo Code:  </td><td><input id=\"promo_code\" value=\"" + vPromoCode + "\"></td></tr></table>" +
            "<button type=\"submit\" id=\"contact-submit\" onClick=\"updateCustomer(\'" + vEmail +"\')\">Update Customer</button>";
            document.getElementById("customers").innerHTML = html;
            } catch(err) {
                console.error("Failed to run query", err);
            }
      }

      async function updateCustomer(aEmail){
        var vPromoCode = document.getElementById("promo_code").value;
        var nDate = new Date();
        try {
            const client = app.currentUser.mongoClient("mongodb-atlas")
            const db = client.db('sample_supplies');
            await db.collection('sales').updateOne(
                {"customer.email": aEmail},
                {$set: {
                    owner_id: app.currentUser.id,
                    promoCode: vPromoCode,
                    last_modified: nDate
                    }
                }
            )
            displayCustomers()
        } catch(err) {
            console.error("Failed to run query", err);
        }
    }
    </script>
  </head>
  <style>
    div {
      margin-left: 30px;
    }
    table td {
      padding: 5px;
    }
  </style>
   <body onload="displayCustomersOnLoad()">
    <div>
      <h2>Promotional Offering</h2>
      <p>
        This simple page demonstrates MongoDB Realm Web SDK functionality in a web browser.
      </p>
      <h3>Search</h3>
      <table>
        <tr><td> Customer Email:</td><td> <input type="text" id="customer_email" name="customer_email"/></td></tr>
        <tr><td> Store Location:</td><td> <input type="text" id="store_location" name="store location"/></td></tr>
        <tr><td> Greater Than Age:</td><td> <input type="text" id="customer_age" name="customer_age"/></td></tr>
      </table>
      <br>
      <button type="submit" onclick="displayCustomers()">Search</button>
      <h3>Results</h3> 
      <iframe width="640" height="480" src="https://charts.mongodb.com/charts-project-0-rftcv/embed/charts?id=14b477d4-130e-41d2-9aa3-63a4365477ee&theme=light"></iframe>
    </div>
    <div id="customers" style="margin-right: 60px;"></div>
  </body>
</html>